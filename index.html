<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Bournemouth Future Cheer 2025</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="config.js"></script>
  <style>
      :root {
        --primary: #007bff;
        --primary-dark: #0056b3;
        --danger: #dc3545;
        --danger-dark: #b52a37;
        --warning: #ffc107;
        --warning-dark: #d39e00;
        --bg: #f0f2f5;
        --text: #222;
        --card-bg: #ffffff;
        --checked-bg: #e0e0e0;
      }

      body.dark {
        --bg: #181a1b;
        --text: #eee;
        --card-bg: #252728;
        --checked-bg: #444;
      }

      body {
        font-family: 'Segoe UI', sans-serif;
        margin: 0;
        padding: 1rem;
        background-color: var(--bg);
        color: var(--text);
        display: flex;
        flex-direction: column;
        align-items: center;
        transition: background-color 0.3s ease, color 0.3s ease;
      }

      h2 {
        margin: 0.5rem 0;
        text-align: center;
        font-size: 1.8rem;
      }

      #counter {
        font-size: 1rem;
        margin-bottom: 1rem;
      }

      #saving {
        text-align: center;
        margin-bottom: 1rem;
        font-style: italic;
        color: #666;
        display: none;
      }

      #list {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        width: 100%;
        max-width: 420px;
      }

      .person {
        display: flex;
        align-items: center;
        justify-content: space-between;
        background-color: var(--card-bg);
        padding: 0.75rem 1rem;
        border-radius: 10px;
        border: 2px solid transparent;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        transition: all 0.3s ease;
      }

      .person.checked {
        background-color: var(--checked-bg);
      }

      .person.absent {
        border: 2px solid var(--danger);
      }

      .person.checked span {
        opacity: 0.6;
        text-decoration: line-through;
      }

      .person span {
        font-size: 1rem;
        flex: 1;
        padding-right: 1rem;
      }

      .person button {
        padding: 0.4rem 0.6rem;
        border: none;
        border-radius: 6px;
        font-size: 0.85rem;
        cursor: pointer;
        transition: background-color 0.2s ease;
        margin-left: 0.4rem;
      }

      .btn-arrive {
        background-color: var(--primary);
        color: white;
      }

      .btn-arrive:hover {
        background-color: var(--primary-dark);
      }

      .btn-undo {
        background-color: var(--warning);
        color: black;
      }
      .btn-undo:hover {
        background-color: var(--warning-dark);
      }

      .btn-absent {
        background-color: var(--danger);
        color: white;
      }
      .btn-absent:hover {
        background-color: var(--danger-dark);
      }

      #toggle-theme {
        margin-top: 2rem;
        font-size: 0.9rem;
        background: none;
        border: 1px solid var(--text);
        padding: 0.5rem 1rem;
        border-radius: 6px;
        color: var(--text);
        cursor: pointer;
      }

      #toggle-theme:hover {
        background-color: var(--card-bg);
      }

    .register-selector {
        position: absolute;
        top: 10px;
        right: 10px;
        display: flex;
        align-items: center;
        gap: 8px;
        z-index: 1;  /* Ensures dropdown appears above other elements */
    }

    .register-selector label {
        color: var(--text);
        font-size: 0.9rem;
    }

    .register-selector select {
        appearance: none;
        background-color: var(--card-bg);
        border: 1px solid var(--text);
        border-radius: 6px;
        padding: 8px 32px 8px 12px;
        font-size: 0.9rem;
        color: var(--text);
        cursor: pointer;
        background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23666666%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.4-12.8z%22%2F%3E%3C%2Fsvg%3E");
        background-repeat: no-repeat;
        background-position: right 12px top 50%;
        background-size: 10px auto;
    }

    .register-selector select:hover {
        border-color: var(--primary);
    }

    .register-selector select:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
    }

    h2 {
        margin: 3rem 0 0.5rem 0;  /* Add top margin to accommodate dropdown */
        text-align: center;
        font-size: 1.8rem;
    }

    @media (max-width: 480px) {
        .register-selector {
            position: static;  /* Changed from relative to static */
            width: 100%;
            max-width: 420px;
            margin-bottom: 1rem;
            justify-content: center;  /* Center the dropdown on mobile */
        }

        h2 {
            margin-top: 0.5rem;  /* Reset margin since dropdown is above */
        }
    }

    footer {
        margin-top: 2rem;
        padding: 1rem;
        text-align: center;
        font-size: 0.8rem;
        color: var(--text);
        opacity: 0.7;
    }
    </style>
</head>
<body>

  <!-- Register Selector Dropdown -->
  <div class="register-selector">
      <label for="sheetSelect">Register:</label>
      <select id="sheetSelect" onchange="switchRegister()">
          <option value="Renegades">Renegades</option>
          <option value="Vengeance">Vengeance</option>
      </select>
  </div>

  <h2>ðŸ“‹ Bournemouth Future Cheer 2025</h2>
  <div id="counter">Loading...</div>
  <div id="saving">ðŸ’¾ Saving...</div>
  <div id="list"></div>
  <button id="toggle-theme" onclick="toggleTheme()">ðŸŒ“ Toggle Dark Mode</button>

  <script>
  let currentRegister = "Vengeance";
  let sheetName = "Sheet1"; // adjust if needed
  let scriptUrl = REGISTER_SCRIPTS[currentRegister];
  let refreshInterval;

  let people = [];

  function updateCounter() {
    const total = people.length;
    const checkedIn = people.filter(p => p.registered).length;
    const absentCount = people.filter(p => p.absent).length;
    const remaining = total - checkedIn - absentCount;
    document.getElementById("counter").textContent = `âœ”ï¸ ${checkedIn} arrived â€¢ â›” ${absentCount} absent â€¢ ðŸ”„ ${remaining} remaining`;
  }

function switchRegister() {
    currentRegister = document.getElementById("sheetSelect").value;
    scriptUrl = REGISTER_SCRIPTS[currentRegister];
    document.querySelector("h2").textContent = `ðŸ“‹ ${currentRegister} - Bournemouth 2025`;
    
    // Clear existing interval if any
    if (refreshInterval) {
      clearInterval(refreshInterval);
    }
    
    loadData(true);
    // Start new refresh interval
    refreshInterval = setInterval(() => loadData(false), 5000);
  }

   async function loadData(isInitialLoad = false) {
    const list = document.getElementById('list');
    // Only show loading on initial load
    if (isInitialLoad) {
      list.innerHTML = 'Loading...';
    }

    try {
      const res = await fetch(`${scriptUrl}?sheet=${encodeURIComponent(sheetName)}`);
      const data = await res.json();

      if (data.error) {
        list.innerHTML = `<p style="color:red;">Error: ${data.error}</p>`;
        return;
      }

      people = data;
      displayData();
    } catch (err) {
      // Only show error if it's the initial load
      if (isInitialLoad) {
        list.innerHTML = `<p style="color:red;">Failed to load data</p>`;
      }
      console.error(err);
    }
  }

    function displayData() {
      const list = document.getElementById('list');
      list.innerHTML = '';

      const sorted = [...people].sort((a, b) => {
        if (a.absent !== b.absent) return a.absent - b.absent;
        if (a.registered !== b.registered) return a.registered - b.registered;
        return a.rowNumber - b.rowNumber;
      });

      updateCounter();

      sorted.forEach(person => {
        const div = document.createElement('div');
        div.className = 'person' +
          (person.registered ? ' checked' : '') +
          (person.absent ? ' absent' : '');

        let buttonHTML = '';

        if (person.absent) {
          buttonHTML = `<button class="btn-undo" onclick="setAbsent(${person.rowNumber}, false)">Undo</button>`;
        } else if (person.registered) {
          buttonHTML = `<button class="btn-undo" onclick="setRegistered(${person.rowNumber}, false)">Undo</button>`;
        } else {
          buttonHTML = `
            <button class="btn-arrive" onclick="setRegistered(${person.rowNumber}, true)">Arrived</button>
            <button class="btn-absent" onclick="setAbsent(${person.rowNumber}, true)">Absent</button>
          `;
        }

        const absentLabel = person.absent ? ` <strong style="color:red;">ABSENT</strong>` : '';
        div.innerHTML = `
          <span>${person.firstName} ${person.surname}${absentLabel}</span>
          ${buttonHTML}
        `;
        list.appendChild(div);
      });
    }

    async function setRegistered(row, status) {
      await updateStatus(row, { registered: status, absent: false });
    }

    async function setAbsent(row, status) {
      await updateStatus(row, { absent: status, registered: false });
    }

    async function updateStatus(row, statusObj) {
      const savingEl = document.getElementById('saving');
      savingEl.style.display = 'block';

      const params = new URLSearchParams({ sheet: sheetName, row });
      for (const key in statusObj) {
        params.append(key, statusObj[key]);
      }

      try {
        await fetch(`${scriptUrl}?${params.toString()}`, { method: 'POST' });

        const person = people.find(p => p.rowNumber === row);
        if (person) {
          Object.assign(person, statusObj);
        }

        displayData();
      } catch (err) {
        alert("Failed to update.");
        console.error(err);
      } finally {
        savingEl.style.display = 'none';
      }
    }

    function toggleTheme() {
      document.body.classList.toggle('dark');
    }

    document.querySelector("h2").textContent = `ðŸ“‹ ${currentRegister} - Bournemouth 2025`;
    loadData(true);
    refreshInterval = setInterval(() => loadData(false), 5000);
  </script>
    <footer>
        Â© Hannah's Bitch 2025. All rights reserved.
    </footer>
</body>
</html>
